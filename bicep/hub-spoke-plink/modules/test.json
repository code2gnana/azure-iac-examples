{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"administratorLogin": {
			"type": "string"
		},
		"administratorLoginPassword": {
			"type": "securestring"
		},
		"location": {
			"type": "string"
		},
		"serverName": {
			"type": "string"
		},
		"serverEdition": {
			"type": "string"
		},
		"vCores": {
			"type": "int",
			"defaultValue": 4
		},
		"storageSizeMB": {
			"type": "int"
		},
		"haEnabled": {
			"type": "string",
			"defaultValue": "Disabled"
		},
		"availabilityZone": {
			"type": "string"
		},
		"version": {
			"type": "string"
		},
		"tags": {
			"type": "object",
			"defaultValue": {}
		},
		"firewallRules": {
			"type": "object",
			"defaultValue": {}
		},
		"backupRetentionDays": {
			"type": "int"
		},
		"geoRedundantBackup": {
			"type": "string"
		},
		"vmName": {
			"type": "string",
			"defaultValue": "Standard_B1ms"
		},
		"publicNetworkAccess": {
			"type": "string",
			"metadata": {
				"description": "Value should be either Enabled or Disabled"
			}
		},
		"storageIops": {
			"type": "int"
		},
	},
	"functions": [],
	"variables": {},
	"resources": [
		{
			"apiVersion": "[variables('api')]",
			"location": "[parameters('location')]",
			"name": "[parameters('serverName')]",
			"dependsOn": [
				"[parameters('networkResourcesDeploymentName')]"
			],
			"properties": {
				"version": "[parameters('version')]",
				"administratorLogin": "[parameters('administratorLogin')]",
				"administratorLoginPassword": "[parameters('administratorLoginPassword')]",
				"publicNetworkAccess": "[parameters('publicNetworkAccess')]",
				"DelegatedSubnetArguments": "[if(empty(parameters('vnetData').delegatedSubnetArguments), json('null'), parameters('vnetData').delegatedSubnetArguments)]",
				"haEnabled": "[parameters('haEnabled')]",
				"storageProfile": {
					"storageMB": "[parameters('storageSizeMB')]",
					"backupRetentionDays": "[parameters('backupRetentionDays')]",
					"geoRedundantBackup": "[parameters('geoRedundantBackup')]",
					"storageIops": "[parameters('storageIops')]"
				},
				"availabilityZone": "[parameters('availabilityZone')]"
			},
			"sku": {
				"name": "[parameters('vmName')]",
				"tier": "[parameters('serverEdition')]",
				"capacity": "[parameters('vCores')]"
			},
			"tags": "[parameters('tags')]",
			"type": "Microsoft.DBforMySQL/flexibleServers"
		},
		{
			"condition": "[greater(length(variables('firewallRules')), 0)]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2019-08-01",
			"name": "[concat('firewallRules-', copyIndex())]",
			"copy": {
				"count": "[if(greater(length(variables('firewallRules')), 0), length(variables('firewallRules')), 1)]",
				"mode": "Serial",
				"name": "firewallRulesIterator"
			},
			"dependsOn": [
				"[concat('Microsoft.DBforMySQL/flexibleServers/', parameters('serverName'))]"
			],
			"properties": {
				"mode": "Incremental",
				"template": {
					"$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
					"contentVersion": "1.0.0.0",
					"resources": [
						{
							"type": "Microsoft.DBforMySQL/flexibleServers/firewallRules",
							"name": "[concat(parameters('serverName'),'/',variables('firewallRules')[copyIndex()].name)]",
							"apiVersion": "[variables('api')]",
							"properties": {
								"StartIpAddress": "[variables('firewallRules')[copyIndex()].startIPAddress]",
								"EndIpAddress": "[variables('firewallRules')[copyIndex()].endIPAddress]"
							}
						}
					]
				}
			}
		}
	],
	"outputs": {}
}