{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"storageUri": {
			"type": "string",
			"defaultValue": null
		},
		"sasToken": {
			"type": "string",
			"defaultValue": null
		},
		"hostName": {
			"type": "string"
		},
		"appGatewaySubnetId": {
			"type": "string"
		},
		"asePrivateIpAddresses": {
			"type": "array"
		},
		"aseHostNames": {
			"type": "array"
		},
		"keyVaultName": {
			"type": "string"
		},
		"certificateId": {
			"type": "string"
		}
	},
	"variables": {
		"suffix": "[substring(uniqueString(resourceGroup().id, subscription().subscriptionId, resourceGroup().location), 0, 6)]"
	},
	"resources": [
		{
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2018-05-01",
			"name": "linkedTemplate-appgwy",
			"dependsOn": [
			],
			"properties": {
				"mode": "Incremental",
				"templateLink": {
					"contentVersion": "1.0.0.0",
					"uri": "[concat(parameters('storageUri'), '/', 'appgwy.json', parameters('sasToken'))]"
				},
				"parameters": {
					"suffix": {
						"value": "[variables('suffix')]"
					},
					"skuName": {
						"value": "Standard"
					},
					"tier": {
						"value": "Regional"
					},
					"hostName": {
						"value": "[parameters('hostName')]"
					},
					"gatewaySku": {
						"value": {
							"name": "WAF_v2",
							"tier": "WAF_v2"
						}
					},
					"subnetId": {
						"value": "[parameters('appGatewaySubnetId')]"
					},
					"frontEndPort": {
						"value": 443
					},
					"requestTimeOut": {
						"value": 180
					},
					"asePrivateIpAddresses": {
						"value": "[parameters('asePrivateIpAddresses')]"
					},
					"keyVaultName": {
						"value": "[parameters('keyVaultName')]"
					},
					"certificateId": {
						"value": "[parameters('certificateId')]"
					},
					"aseHostNames": {
						"value": "[parameters('aseHostNames')]"
					}
				}
			}
		},
		{
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2018-05-01",
			"name": "linkedTemplate-update-nsg",
			"dependsOn": [
				"linkedTemplate-appgwy"
			],
			"properties": {
				"mode": "Incremental",
				"templateLink": {
					"contentVersion": "1.0.0.0",
					"uri": "[concat(parameters('storageUri'), '/', 'nsg.json', parameters('sasToken'))]"
				},
				"parameters": {
					"suffix": {
						"value": "[variables('suffix')]"
					}
/* 					"appGatewayPublicIpAddress": {
						"value": "[reference('Microsoft.Resources/deployments/linkedTemplate-appgwy').outputs.appGatewayPublicIpAddress.value]"
					} */
				}
			}
		}
	],
	"outputs": {}
}